<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Finalize Order</title>
    <style>
        /* P6: Premium Book Theme CSS */
        body { 
            font-family: 'Georgia', serif; 
            margin: 0; 
            background-color: #FBF7F0; /* Premium Parchment */
            /* A.3: Navigation Overlap Fix - Add padding equal to navigation bar height */
            padding-bottom: 70px; 
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #ffffff; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.05); 
            min-height: calc(100vh - 70px);
        }
        h1 { color: #60281E; /* Deep Mahogany Title */ font-size: 1.5em; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #555; }
        .input-style, textarea { 
            width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; 
            font-family: 'Georgia', serif;
        }
        textarea { resize: vertical; min-height: 80px; }
        
        /* Price Display & Details */
        .price-details { margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; }
        .price-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 1em; }
        .grand-total { font-size: 1.3em; font-weight: bold; color: #60281E; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 10px; }
        .grand-total span:last-child { color: #B8860B !important; } /* Muted Gold Accent for total */
        
        /* Premium Buttons (C.6: Binding Color) */
        #paymentButton { 
            width: 100%; padding: 14px; 
            background-color: #60281E; 
            color: white; border: none; 
            border-radius: 4px; font-size: 1.1em; 
            cursor: pointer; margin-top: 25px; 
            text-transform: uppercase;
        }
        #paymentButton:hover { background-color: #4A2016; }
        
        .note-box { margin-top: 15px; padding: 10px; background-color: #fff8e1; border: 1px solid #B8860B; border-radius: 5px; font-size: 0.9em; color: #333; text-align: center; }
        
        /* P3/A.2: Shipping Option Styles */
        .options-section { border: 1px solid #ccc; border-radius: 5px; padding: 15px; margin-top: 20px; background-color: #f9f9f9; }
        .options-section h3 { margin-top: 0; font-size: 1.1em; color: #60281E; }
        .radio-option { margin-bottom: 10px; font-size: 0.95em; }
        .radio-option label { font-weight: normal; color: #333; display: inline-block; }

        /* C.7: Persistent Navigation Bar Styling */
        .nav-bar {
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 1px solid #ddd;
            padding: 10px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .nav-bar a {
            text-decoration: none;
            color: #60281E; /* Mahogany link color */
            font-size: 0.8em;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Shipping & Payment</h1>

        <form id="paymentForm" action="YOUR_APPS_SCRIPT_URL_HERE" method="POST">
            
            <label for="customer_name_input">Customer Name *</label>
            <input type="text" id="customer_name_input" class="input-style" placeholder="Your Full Name" required>

            <label for="phone_number_input">Phone Number *</label>
            <input type="tel" id="phone_number_input" class="input-style" placeholder="1234567890" required>

            <label for="shipping_address_input">Shipping Address *</label>
            <textarea id="shipping_address_input" class="input-style" placeholder="House/Flat No., Street, City, State" required></textarea>

            <label for="pincode_input">Pincode *</label>
            <input type="number" id="pincode_input" class="input-style" placeholder="123456" required>
            
            <div class="options-section">
                <h3>Select Delivery Method</h3>
                <div class="radio-option">
                    <input type="radio" id="shipping_standard" name="shipping_type" value="49.00" data-method="Standard Courier" checked>
                    <label for="shipping_standard">Standard Shipping (3-5 Days) - ‚Çπ49.00</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="shipping_express" name="shipping_type" value="99.00" data-method="Express Shipping">
                    <label for="shipping_express">Express Shipping (1-2 Days) - ‚Çπ99.00</label>
                </div>
            </div>

            <div class="price-details">
                <h2 style="font-size: 1.2em; color: #60281E;">Final Price Details</h2>
                
                <div class="price-row"><span>Book Price</span><span id="book_price_display">‚Çπ0.00</span></div>
                <div class="price-row"><span>Shipping & Handling</span><span id="shipping_display">‚Çπ0.00</span></div>
                
                <div class="price-row grand-total"><span>Grand Total</span><span id="grand_total_display">‚Çπ0.00</span></div>
            </div>
            
            <input type="hidden" name="Customer_Naml" id="hidden_customer_name">
            <input type="hidden" name="Phone_Number" id="hidden_phone_number">
            <input type="hidden" name="Pincode" id="hidden_pincode">
            <input type="hidden" name="Shipping_Addri" id="hidden_shipping_address">
            <input type="hidden" name="Delivery_Methd" id="hidden_delivery_method">
            <input type="hidden" name="Support_Amou" id="hidden_support_amount" value="0.00"> <input type="hidden" name="Final_Total" id="hidden_final_total">
            <input type="hidden" name="Book_Title" id="hidden_book_title">

            <button type="submit" id="paymentButton">Proceed to Payment</button>
            
            <div class="note-box">
                You will be redirected to your UPI app for payment (PhonePe, GPay, Paytm, etc.)
            </div>
        </form>
    </div>

    <div class="nav-bar">
        <a href="index.html">üè† Home</a>
        <a href="cart.html">üõí Cart</a>
        <a href="profile.html">üë§ Profile</a>
    </div>

    <script>
        // Set your UPI ID and the thanks page URL here
        const YOUR_UPI_ID = "testmerchant@ybl"; // Placeholder for testing
        const THANK_YOU_URL = encodeURIComponent("https://eatornik.github.io/thankyou.html");
        
        let bookPrice = 0;
        let shippingFee = 0;
        let grandTotal = 0;
        let deliveryMethod = "Standard Courier";
        
        // Function to calculate and update the displayed total
        function updatePrice() {
            const selectedShippingRadio = document.querySelector('input[name="shipping_type"]:checked');
            shippingFee = parseFloat(selectedShippingRadio.value);
            deliveryMethod = selectedShippingRadio.getAttribute('data-method');
            
            grandTotal = bookPrice + shippingFee;
            
            document.getElementById('shipping_display').textContent = `+ ‚Çπ${shippingFee.toFixed(2)}`;
            document.getElementById('grand_total_display').textContent = `‚Çπ${grandTotal.toFixed(2)}`;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Get the data from localStorage
            const data = JSON.parse(localStorage.getItem('formData'));
            
            if (!data || !data.Book_Price) {
                alert("Error: No book selected. Returning home.");
                window.location.href = 'index.html';
                return;
            }

            bookPrice = parseFloat(data.Book_Price) || 0;
            
            // Initial Price Display
            document.getElementById('book_price_display').textContent = `‚Çπ${bookPrice.toFixed(2)}`;
            
            // P3/A.2: Attach event listeners to shipping radios
            const shippingRadios = document.querySelectorAll('input[name="shipping_type"]');
            shippingRadios.forEach(radio => radio.addEventListener('change', updatePrice));
            
            // Initial calculation
            updatePrice();
            
            const form = document.getElementById('paymentForm');

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                // 1. Final check for total
                updatePrice(); 

                // 2. Gather ALL form data
                const finalData = {
                    Customer_Name: document.getElementById('customer_name_input').value,
                    Phone_Number: document.getElementById('phone_number_input').value,
                    Shipping_Address: document.getElementById('shipping_address_input').value,
                    Pincode: document.getElementById('pincode_input').value,
                    Book_Title: data.Book_Title || "UNKNOWN",
                };
                
                // 3. Populate the HIDDEN FORM FIELDS (P1: CRITICAL FIX)
                document.getElementById('hidden_customer_name').value = finalData.Customer_Name;
                document.getElementById('hidden_phone_number').value = finalData.Phone_Number;
                document.getElementById('hidden_pincode').value = finalData.Pincode;
                document.getElementById('hidden_shipping_address').value = finalData.Shipping_Address;
                
                // Set final calculated values for the sheet
                document.getElementById('hidden_delivery_method').value = deliveryMethod; 
                document.getElementById('hidden_final_total').value = grandTotal.toFixed(2);
                document.getElementById('hidden_book_title').value = finalData.Book_Title;
                // hidden_support_amount remains 0.00 as we removed the fee

                // 4. Apps Script Submission (sends data to Google Sheet)
                const formData = new FormData(form);
                fetch(form.action, { method: 'POST', body: formData })
                    .then(response => {
                        if (!response.ok) {
                            console.error('Apps Script submission failed.');
                            alert("There was an issue saving your order data. Please try again.");
                            return;
                        }

                        // 5. UPI Deep Link Generation (Ultra-Compact Note: Book|Pincode|Phone|Name)
                        const encodedTotal = grandTotal.toFixed(2);
                        const finalNote = `${finalData.Book_Title}|${finalData.Pincode}|${finalData.Phone_Number}|${finalData.Customer_Name}`;
                        const encodedNote = encodeURIComponent(finalNote);

                        const upiUrl = `upi://pay?pa=${YOUR_UPI_ID}&pn=AuthorDirect&mc=5499&tid=${Date.now()}&tr=${Date.now()}&am=${encodedTotal}&cu=INR&url=${THANK_YOU_URL}&tn=${encodedNote}`;
                        
                        // 6. Redirect to UPI App
                        window.location.href = upiUrl;

                    })
                    .catch(error => {
                        console.error('Submission error:', error);
                        alert("An error occurred during submission. Please check your connection and try again.");
                    });
            });
        });
    </script>
</body>
</html>